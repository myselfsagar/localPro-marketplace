<%- include('../partials/header') %> <%- include('../partials/_messages') %>

<main class="container">
  <h1>Welcome to your Dashboard, <%= user.firstName %>!</h1>
  <hr />

  <div class="collapsible-header" id="bookingsToggle">
    <h2>My Bookings</h2>
    <span class="toggle-icon">â–¼</span>
  </div>

  <div class="collapsible-content" id="bookingsContent">
    <% if (bookings.length > 0) { %>
    <div class="booking-list">
      <% bookings.forEach(booking => { %>
      <div class="booking-card">
        <% if (booking.Service) { %> <% if (user.role === 'customer') { %>
        <h4><%= booking.Service.name %></h4>
        <p>
          with
          <strong><%= booking.Service.ProviderProfile.businessName %></strong>
        </p>
        <% } else { %>
        <h4><%= booking.Service.name %></h4>
        <p>
          with
          <strong
            ><%= booking.Customer.firstName %> <%= booking.Customer.lastName
            %></strong
          >
        </p>
        <% } %>

        <p>Price: <strong>$<%= booking.Service.price %></strong></p>
        <p>Date: <%= new Date(booking.bookingDate).toLocaleString() %></p>
        <p>
          Status:
          <span class="status-<%= booking.status %>"
            ><%= booking.status %></span
          >
        </p>

        <% if (user.role === 'customer' && booking.status === 'completed' &&
        !booking.Review) { %>
        <div class="booking-actions">
          <a href="/reviews/new/<%= booking.id %>" class="btn"
            >Leave a Review</a
          >
        </div>
        <% } %> <% if (user.role === 'provider') { %> <% if (booking.status ===
        'pending') { %>
        <div class="booking-actions">
          <form
            action="/provider/bookings/<%= booking.id %>/status"
            method="POST"
            style="display: inline"
          >
            <input type="hidden" name="status" value="confirmed" />
            <button type="submit" class="btn-confirm">Confirm</button>
          </form>
          <form
            action="/provider/bookings/<%= booking.id %>/status"
            method="POST"
            style="display: inline"
          >
            <input type="hidden" name="status" value="cancelled" />
            <button type="submit" class="btn-cancel">Cancel</button>
          </form>
        </div>
        <% } else if (booking.status === 'confirmed') { %>
        <div class="booking-actions">
          <form
            action="/provider/bookings/<%= booking.id %>/status"
            method="POST"
            style="display: inline"
          >
            <input type="hidden" name="status" value="completed" />
            <button type="submit" class="btn-complete">
              Mark as Completed
            </button>
          </form>
        </div>
        <% } %> <% } %> <% } else { %>
        <h4>[Deleted Service]</h4>
        <p>This booking's associated service has been removed.</p>
        <p>
          Status:
          <span class="status-<%= booking.status %>"
            ><%= booking.status %></span
          >
        </p>
        <% } %>
      </div>
      <% }) %>
    </div>
    <% } else { %>
    <p id="noBookingsMsg">You have no bookings yet.</p>
    <% } %>

    <div class="pagination-controls">
      <% if (currentPage > 1) { %>
      <a href="/dashboard?page=<%= currentPage - 1 %>" class="btn"
        >&laquo; Previous</a
      >
      <% } %> <% for(let i = 1; i <= totalPages; i++) { %> <% if (i ===
      currentPage) { %>
      <a href="/dashboard?page=<%= i %>" class="btn btn-current"><%= i %></a>
      <% } else { %>
      <a href="/dashboard?page=<%= i %>" class="btn"><%= i %></a>
      <% } %> <% } %> <% if (currentPage < totalPages) { %>
      <a href="/dashboard?page=<%= currentPage + 1 %>" class="btn"
        >Next &raquo;</a
      >
      <% } %>
    </div>
  </div>
  <% if (user.role === 'provider') { %>
  <p style="margin-top: 2rem">
    <a href="/provider/profile">Manage Your Profile & Services</a>
  </p>
  <% } %>
</main>

<%- include('../partials/footer') %>
